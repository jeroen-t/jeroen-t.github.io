<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Update Azure NSG security rules using Bicep - Jeroen Trimbach</title><meta name="description" content="Update Azure Network Security Groups using Bicep"><meta property="og:title" content="Update Azure NSG security rules using Bicep" />
<meta property="og:description" content="Update Azure Network Security Groups using Bicep" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jeroentrimbach.com/2022/05/azure-update-nsg-rules-bicep/" /><meta property="og:image" content="https://jeroentrimbach.com/2022/05/azure-update-nsg-rules-bicep/featured-image.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-16T21:51:16+02:00" />
<meta property="article:modified_time" content="2022-05-27T21:15:54+02:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://jeroentrimbach.com/2022/05/azure-update-nsg-rules-bicep/featured-image.png"/>
<meta name="twitter:title" content="Update Azure NSG security rules using Bicep"/>
<meta name="twitter:description" content="Update Azure Network Security Groups using Bicep"/>
<meta name="application-name" content="jTrimbach">
<meta name="apple-mobile-web-app-title" content="jTrimbach"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://jeroentrimbach.com/2022/05/azure-update-nsg-rules-bicep/" /><link rel="prev" href="https://jeroentrimbach.com/2022/05/azure-boards-bulk-planning/" /><link rel="stylesheet" href="/css/page.min.css"><link rel="stylesheet" href="/css/home.min.css">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NZDT366YND"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-NZDT366YND', { 'anonymize_ip': false });
}
</script>



<meta name="google-site-verification" content="276260495" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Update Azure NSG security rules using Bicep",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/jeroentrimbach.com\/2022\/05\/azure-update-nsg-rules-bicep\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/jeroentrimbach.com\/2022\/05\/azure-update-nsg-rules-bicep\/featured-image.png",
                            "width":  1000 ,
                            "height":  500 
                        }],"genre": "posts","keywords": "Blog, Azure, Bicep, Network Security Group, NSG, jq, ARM","wordcount":  1889 ,
        "url": "https:\/\/jeroentrimbach.com\/2022\/05\/azure-update-nsg-rules-bicep\/","datePublished": "2022-05-16T21:51:16+02:00","dateModified": "2022-05-27T21:15:54+02:00","publisher": {
            "@type": "Organization",
            "name": "Jeroen Trimbach"},"author": {
                "@type": "Person",
                "name": "Jeroen Trimbach"
            },"description": "Update Azure Network Security Groups using Bicep"
    }
    </script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NZDT366YND"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-NZDT366YND', { 'anonymize_ip': false });
}
</script>
</head><body data-header-desktop="normal" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Jeroen Trimbach"><span class="header-title-pre"><i class='fa fa-terminal'></i> </span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/categories/documentation/"> Docs </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Looking for something?" id="search-input-desktop">
                        <a href="#" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Jeroen Trimbach"><span class="header-title-pre"><i class='fa fa-terminal'></i> </span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Looking for something?" id="search-input-mobile">
                        <a href="#" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/categories/documentation/" title="">Docs</a><a class="menu-item" href="/about/" title="">About</a><div class="menu-item"><a href="javascript:void(0);" class="theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div></div>
    </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single" data-toc="enable"><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/2022/05/azure-update-nsg-rules-bicep/featured-image.png"
        data-srcset="/2022/05/azure-update-nsg-rules-bicep/featured-image.png, /2022/05/azure-update-nsg-rules-bicep/featured-image.png 1.5x, /2022/05/azure-update-nsg-rules-bicep/featured-image.png 2x"
        data-sizes="auto"
        alt="/2022/05/azure-update-nsg-rules-bicep/featured-image.png"
        title="Update Azure Network Security Groups using Bicep" /></div><div class="single-card" data-image="true"><h2 class="single-title animated flipInX">Update Azure NSG security rules using Bicep</h2><h2 class="single-subtitle">Update Azure Network Security Groups (NSG&#39;s) using Bicep</h2><div class="post-meta">
                <div class="post-meta-line"><span class="post-author"><a href="https://jeroentrimbach.com" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Jeroen Trimbach</a></span>&nbsp;<span class="post-category">published in <a href="/categories/learning/"><i class="far fa-folder fa-fw"></i>Learning</a></span></div>
                <div class="post-meta-line"><span><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="16-05-2022">16-05-2022</time></span>&nbsp;<span><i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1889 words</span>&nbsp;
                    <span><i class="far fa-clock fa-fw"></i>&nbsp;9 minutes</span>&nbsp;</div>
            </div>
            
            <hr><div class="details toc" id="toc-static"  data-kept="">
                    <div class="details-summary toc-title">
                        <span>Contents</span>
                        <span><i class="details-icon fas fa-angle-right"></i></span>
                    </div>
                    <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#u-networkSecurityGroup">Network Security Group deployment template</a>
      <ul>
        <li><a href="#u-priority">How to define priority</a></li>
        <li><a href="#u-customRules">An approach on custom rule(s)</a></li>
      </ul>
    </li>
    <li><a href="#u-securityRuleParameters">Working with the Network Security Rules parameter template</a>
      <ul>
        <li><a href="#u-nsgRestApi">The Azure Network Security Group Rest Api</a></li>
        <li><a href="#u-jsonQuery">Filtering JSON data with jq</a></li>
        <li><a href="#u-getSecurityRules">Putting it all together in a bash script</a></li>
      </ul>
    </li>
    <li><a href="#u-whatIf">(What-If) deployment</a></li>
    <li><a href="#u-pipeline">Deployment pipeline</a></li>
    <li><a href="#u-conclusion">Conclusion</a></li>
  </ul>
</nav></div>
                </div><div class="content" id="content"><p>In this post I will be explaining how you can utilize Bicep (an Infrastructure as Code (IaC) language) for creating and/or updating the security rules on a Network Security Group (NSG) in Microsoft Azure. I have also shared a script which can be used to export a deployment template based on the security rules configured on an existing NSG resource so that you can use that for further deployments.</p>
<h1 id="update-azure-network-security-group-nsg-security-rules-using-bicep">Update Azure Network Security Group (NSG) security rules using Bicep</h1>
<p>Together with a colleague, I had to create and update a large amount of security rules on Azure Network Security Groups (NSGs) across multiple environments. Normally we would use an ARM deployment template to do NSG deployments. However, the logic used in the script could not achieve what was required and because it is an ARM template, quite complex as well. Instead of rewriting the template we decided to create a new template written in Bicep instead.</p>
<p>In this post I will go over the template as well as some other things I have learned/played with during that process.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="AzureNetworkSecurityGroup.gif"
        data-srcset="/2022/05/azure-update-nsg-rules-bicep/AzureNetworkSecurityGroup.gif, AzureNetworkSecurityGroup.gif 1.5x, /2022/05/azure-update-nsg-rules-bicep/AzureNetworkSecurityGroup.gif 2x"
        data-sizes="auto"
        alt="/2022/05/azure-update-nsg-rules-bicep/AzureNetworkSecurityGroup.gif"
        title="Azure Network Security Group" /></p>
<h2 id="u-networkSecurityGroup">Network Security Group deployment template</h2>
<p>The template format for a NSG is quite straight forward. There aren&rsquo;t that many properties and child resources to configure. You can find the full template format in <a href="https://docs.microsoft.com/en-us/azure/templates/microsoft.network/networksecuritygroups?tabs=bicep" target="_blank" rel="noopener noreffer">the Microsoft template documentation</a>. But as you properly already have noticed most of the properties have a singular and plural form (e.g. <code>destinationAddressPrefix</code> and <code>destinationAddressPrefixes</code>). My first thought was that it would be handy to only specify one of those properties in the parameters and based on the amount of values/prefixes specified in the parameter decide whether it should be the singular or plural form. But I soon realized that it was not an ideal solution. Instead Bicep has the <code>contains</code> <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/bicep-functions-object#contains" target="_blank" rel="noopener noreffer">object function</a> that can be used. It can check whether an object contains a key and with that information we can decide whether we do something with that information or not. In our case if the key is present we want to assign the value and if is not pass an empty value (singular empty string, or pural an empty array).</p>
<div class="details admonition failure open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-times-circle fa-fw"></i>InvalidTemplateDeployment<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>If you make the above mistake you will run into an <strong>InvalidTemplateDeployment</strong> error:</p>
<blockquote>
<p>InvalidTemplateDeployment - The template deployment &lsquo;$DEPLOYMENT_NAME&rsquo; is not valid according to the validation procedure. The tracking id is &lsquo;$TRACKING_ID&rsquo;. See inner errors for details.
SecurityRuleParameterContainsUnsupportedValue - Security rule parameter DestinationAddressPrefix for rule with Id /subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCEGROUP_NAME/providers/Microsoft.Network/networkSecurityGroups/$NSG_NAME/securityRules/allow-http cannot specify existing VIRTUALNETWORK, INTERNET, AZURELOADBALANCER, &lsquo;*&rsquo; or system tags. Unsupported value used: *.</p>
</blockquote>
<p>The deployment failed because the asterisk (*) wildcard character was given as a value for the <code>destionationAddressPrefixes</code> key. The deployment would have succeeded if instead the value was given for the <code>destionAddressPrefix</code> key. This is also the case for any of the service tags such as VIRTUALNETWORK, INTERNET, AZURELOADBALANCER, etc.</p>
<p>In the JSON snippet below is an example of a security rule that would throw the <code>InvalidTemplateDeployment</code> error.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="hl"><span class="lnt"> 6
</span></span><span class="hl"><span class="lnt"> 7
</span></span><span class="hl"><span class="lnt"> 8
</span></span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-JSON" data-lang="JSON"><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;allow-http&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;access&#34;</span><span class="p">:</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;destinationAddressPrefix&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">            <span class="nt">&#34;destinationAddressPrefixes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">              <span class="s2">&#34;*&#34;</span>
</span></span><span class="line hl"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;destinationPortRange&#34;</span><span class="p">:</span> <span class="s2">&#34;80&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;destinationPortRanges&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;direction&#34;</span><span class="p">:</span> <span class="s2">&#34;Inbound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;Tcp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;priority&#34;</span><span class="p">:</span> <span class="s2">&#34;150&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;sourceAddressPrefix&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;sourceAddressPrefixes&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;sourcePortRange&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;sourcePortRanges&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this case the asterisk (*) wildcard character should have been a value of the <code>destinationAddressPrefix</code> key (e.g &ldquo;destinationAddressPrefix&rdquo;: &ldquo;*&rdquo;).</p>
</div>
        </div>
    </div>
<p>With what we know now the following template can be used:</p>
<script  src="https://gist.github.com/jeroen-t/91d380a8cad231a64df1a4e4745ca51a.js?file=nsg.bicep"></script>

<p>Great! Before we dive into the security rules lets discuss another approach we can take to the priority.</p>
<h3 id="u-priority">How to define priority</h3>
<p>Instead of specifying the priority for each rule that you create you can also do some more tweaking to the template. For example, instead of giving priority like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="hl"><span class="lnt"> 6
</span></span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="hl"><span class="lnt">15
</span></span><span class="hl"><span class="lnt">16
</span></span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Bicep" data-lang="Bicep"><span class="line hl"><span class="cl"><span class="kd">var</span><span class="w"> </span>securityRuleArray<span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="k">for</span><span class="w"> </span><span class="p">(</span>securityRule<span class="err">,</span><span class="w"> </span>i<span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="py">securityRules</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="py">name</span><span class="p">:</span><span class="w"> </span>securityRule<span class="p">.</span>name<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="py">properties</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="py">access</span><span class="p">:</span><span class="w"> </span>securityRule<span class="p">.</span>properties<span class="p">.</span>access<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="py">destinationAddressPrefix</span><span class="p">:</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span>securityRule<span class="p">.</span>properties<span class="err">,</span><span class="w"> </span><span class="si">&#39;destinationAddressPrefix&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">?</span><span class="w"> </span>securityRule<span class="p">.</span>properties<span class="p">.</span>destinationAddressPrefix<span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="py">destinationAddressPrefixes</span><span class="p">:</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span>securityRule<span class="p">.</span>properties<span class="err">,</span><span class="w"> </span><span class="si">&#39;destinationAddressPrefixes&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">?</span><span class="w"> </span>securityRule<span class="p">.</span>properties<span class="p">.</span>destinationAddressPrefixes<span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="py">destinationPortRange</span><span class="p">:</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span>securityRule<span class="p">.</span>properties<span class="err">,</span><span class="w"> </span><span class="si">&#39;destinationPortRange&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">?</span><span class="w"> </span>securityRule<span class="p">.</span>properties<span class="p">.</span>destinationPortRange<span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="py">destinationPortRanges</span><span class="p">:</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span>securityRule<span class="p">.</span>properties<span class="err">,</span><span class="w"> </span><span class="si">&#39;destinationPortRanges&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">?</span><span class="w"> </span>securityRule<span class="p">.</span>properties<span class="p">.</span>destinationPortRanges<span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="py">direction</span><span class="p">:</span><span class="w"> </span>securityRule<span class="p">.</span>properties<span class="p">.</span>direction<span class="w">
</span></span></span><span class="line hl"><span class="cl"><span class="w">  </span><span class="o">--</span><span class="py">priority</span><span class="p">:</span><span class="w"> </span>securityRule<span class="p">.</span>properties<span class="p">.</span>priority<span class="w"> </span><span class="c1">//remove</span><span class="w">
</span></span></span><span class="line hl"><span class="cl"><span class="w">  </span><span class="o">++</span><span class="py">priority</span><span class="p">:</span><span class="w"> </span>100<span class="w"> </span><span class="o">+</span><span class="w"> </span>i<span class="w"> </span><span class="c1">//add</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="py">protocol</span><span class="p">:</span><span class="w"> </span>securityRule<span class="p">.</span>properties<span class="p">.</span>protocol<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="py">sourceAddressPrefix</span><span class="p">:</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span>securityRule<span class="p">.</span>properties<span class="err">,</span><span class="w"> </span><span class="si">&#39;sourceAddressPrefix&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">?</span><span class="w"> </span>securityRule<span class="p">.</span>properties<span class="p">.</span>sourceAddressPrefix<span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="py">sourceAddressPrefixes</span><span class="p">:</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span>securityRule<span class="p">.</span>properties<span class="err">,</span><span class="w"> </span><span class="si">&#39;sourceAddressPrefixes&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">?</span><span class="w"> </span>securityRule<span class="p">.</span>properties<span class="p">.</span>sourceAddressPrefixes<span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="py">sourcePortRange</span><span class="p">:</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span>securityRule<span class="p">.</span>properties<span class="err">,</span><span class="w"> </span><span class="si">&#39;sourcePortRange&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">?</span><span class="w"> </span>securityRule<span class="p">.</span>properties<span class="p">.</span>sourcePortRange<span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="py">sourcePortRanges</span><span class="p">:</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span>securityRule<span class="p">.</span>properties<span class="err">,</span><span class="w"> </span><span class="si">&#39;sourcePortRanges&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">?</span><span class="w"> </span>securityRule<span class="p">.</span>properties<span class="p">.</span>sourcePortRanges<span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>In this example you don&rsquo;t have to give the priority for each rule that you provide in the deployment parameters. Instead based on the order of your rules the rules will get a priority starting from 100 and each rule afterwards will go up by one.</p>
<h3 id="u-customRules">An approach on custom rule(s)</h3>
<p>Great! We have our deployment template. But how do we provide our security rules to the securityRules parameter?
I was going through the options and the two cleanest way of specifying the parameters were either:</p>
<ol>
<li>By having the security rules in a separate json file and using the loadTextContent file function to load the content of the specified file as a string. You can then use the json function to create a JSON objects from this. You can even concatenate the rules of multiple json files using this method. The properties loaded by these functions even have intelliSense in Visual Studio Code as well, cool! An example of the JSON function together with the loadTextContent can be <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/bicep-functions-files#examples" target="_blank" rel="noopener noreffer">found here</a>. Yup, good example because it&rsquo;s using a NSG as well.</li>
<li>By just using the good old <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/parameter-files" target="_blank" rel="noopener noreffer">ARM deployment parameters template</a>.</li>
</ol>
<p>I chose to go with the second method but might try the first option again later. Concatinating a standard set of rules and your more customized rules does have its appeal.</p>
<h2 id="u-securityRuleParameters">Working with the Network Security Rules parameter template</h2>
<p>As mentioned above we are going with the deployment parameters option. Without any rules specified the template looks like this:</p>
<script  src="https://gist.github.com/jeroen-t/91d380a8cad231a64df1a4e4745ca51a.js?file=template.parameters.json"></script>

<p>Yup, very empty! You could also add the nsgName or tags parameters to the template file.</p>
<p>Because I already had an existing NSG which has a lot of rules in place instead of manually typing them all out, I wanted to find a way to easily fetch those. Lets try that.</p>
<h3 id="u-nsgRestApi">The Azure Network Security Group Rest Api</h3>
<p>My colleague pointed me in the direction of the Network Security Group Rest API:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">az rest --method get --uri <span class="s2">&#34;https://management.azure.com/subscriptions/</span><span class="nv">$SUBSCRIPTION_ID</span><span class="s2">/resourceGroups/</span><span class="nv">$resourceGroup</span><span class="s2">/providers/Microsoft.Network/networkSecurityGroups/</span><span class="nv">$networkSecurityGroup</span><span class="s2">?api-version=2021-08-01&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This returns all the information we need and more.. as you can see from the <a href="https://docs.microsoft.com/en-us/rest/api/virtualnetwork/network-security-groups/get#examples" target="_blank" rel="noopener noreffer">sample response</a>. In case of a single destination port the API returns the singular key and its value (e.g. &ldquo;destinationPortRange&rdquo;: &ldquo;80&rdquo;) and in case of plural it returns the plural key and its values in an array. The only problem we have now is that there are other properties coming in as well. Like the id, etag, type and provisioningState. We don&rsquo;t need those but luckily I had played with <code>jq</code> in the past and just found a new use case to play with the tool. So lets dig in.</p>
<h3 id="u-jsonQuery">Filtering JSON data with jq</h3>
<p>From <a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener noreffer">the jq site:</a></p>
<blockquote>
<p>jq is like <code>sed</code> for JSON data - you can use it to slice and filter and map and transform structured data with the same ease that <code>sed</code>, <code>awk</code>, <code>grep</code> and friends let you play with text.</p>
</blockquote>
<p>Perfect! Just what we need for both our use cases.</p>
<p>There is also documentation available on the site for all the commands (or try searching on StackOverflow if you are stuck ðŸ˜‰)</p>
<p>First the unneccesary properties need to be removed. We can use the builtin function <code>del</code> for this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$input | jq &#39;del(.properties.securityRules[] | .id, .etag, .type, .properties.provisioningState) | .properties.securityRules&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Where <code>$input</code> is what is returned to us when we called the rest api method earlier. We pipe the output in <code>jq</code>, remove the specified keys and their values, and only return the custom security rules.</p>
<p>Now that we have the cleaned up security rules we want to store those in our template file. We can achieve this as well through <code>jq</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">jq --argjson input &#34;$securityRules&#34; &#39;.parameters.securityRules.value += $input&#39; $inputTemplate &gt; $outputTemplate
</span></span></code></pre></td></tr></table>
</div>
</div><p>We add the security rules we got returned earlier to the security rule values in the deploymentParameters template and output this as a new deploymentParameter file.
And as you probably already have guessed by now.. The output file is what we are going to end up using as our deployment paramater file :-)</p>
<p>As you can see <code>jq</code> is a very powerful commandline tool and on top of that it is a lot of fun figuring out how to use it!</p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Azure Pipelines Agents <i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p><code>jq</code> is also part of the installed software on the Microsoft hosted Azure Pipelines agents images:</p>
<ul>
<li><a href="https://github.com/actions/virtual-environments/blob/main/images/win/Windows2022-Readme.md" target="_blank" rel="noopener noreffer">Windows Server 2022</a></li>
<li><a href="https://github.com/actions/virtual-environments/blob/main/images/linux/Ubuntu2204-Readme.md" target="_blank" rel="noopener noreffer">Ubuntu 22.04 Preview</a></li>
</ul>
</div>
        </div>
    </div>
<p><a href="https://jqplay.org/" target="_blank" rel="noopener noreffer">Here&rsquo;s a playground</a> for <code>jq</code> if you want to take it for a quick spin.</p>
<div class="details admonition tip">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>yq<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><a href="https://github.com/mikefarah/yq" target="_blank" rel="noopener noreffer">yq</a> is also a handy tool to have. It&rsquo;s similar to <code>jq</code> and works for YAML files as well. Fun to use when you work a lot with YAML files which is definitely the case if you work with pipelines, kubernetes, etc.</div>
        </div>
    </div>
<p>In the above examples we have learned how we can get the custom security rules by calling the Network Security Group Rest API using a GET request. We used the <code>jq</code> commandline tool to extract the security rules and deleted the keys that we didn&rsquo;t need and we have used the <code>jq</code> tool to combine the security rules in a deploymentParameter template. We can put this all together into a PowerShell and/or Bash script.</p>
<h3 id="u-getSecurityRules">Putting it all together in a bash script</h3>
<p>By putting everything that we have just learned together we come up with the following bash script. I added the <code>getopts</code> command for easy parsing of commandline arguments:</p>
<script  src="https://gist.github.com/jeroen-t/91d380a8cad231a64df1a4e4745ca51a.js?file=getSecurityRules.sh"></script>

<p>If we run the above script for a given resource group and network security group:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./getSecurityRules -n Nsg1 -r ResourceGroup1
</span></span></code></pre></td></tr></table>
</div>
</div><p>It will return an deployment parameter file with the name <code>Nsg1.parameters.json</code> in the same directory as where the executed script is located. We can use the parameter file for our future deployments. Lets take a look at how we can deploy new security rules using template.</p>
<h2 id="u-whatIf">(What-If) deployment</h2>
<p>For now lets do an What-if deployment without editing the file. The What-if deployment will only predict what will happen if we deploy our template file. It won&rsquo;t make any changes to the existing NSG or its rules. So in our case this should only show ignored resources and not show any changes (apart from some garbage perhaps).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">az deployment group what-if --resource-group rg1 --name updateNsg --template-file ./nsg.bicep --parameters @nsg1.template.json --parameters <span class="nv">nsgName</span><span class="o">=</span>nsg1
</span></span></code></pre></td></tr></table>
</div>
</div><p>And of course if we want to update our rules we just modify the rules in the our <code>template.json</code> file. When we want to do an actual deployment we can just run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">az deployment group create --resource-group rg1 --name updateNsg --template-file ./nsg.bicep --parameters @nsg1.template.json --parameters <span class="nv">nsgName</span><span class="o">=</span>nsg1
</span></span></code></pre></td></tr></table>
</div>
</div><p>If the validation against Azure Resource Manager succeeds our deployment should kickstart and succesfully get deployed.</p>
<h2 id="u-pipeline">Deployment pipeline</h2>
<p>The What-If deployment followed by the actual deployment can get combined into an Azure Pipelines deployment pipeline. For example, when you update the parameter template with a new rule the pipeline will get triggered. First it will run a validation stage which runs the what-if deployment against your environment and returns results of what security rules get created, modified and/or removed. Then you can have an additional stage which will do the actual deployment after a review approval is done. I really like this approach since it gives you more confidence in your deployments.</p>
<p>I am planning on writing a post about this as well since there is a lot to write about this topic.</p>
<h2 id="u-conclusion">Conclusion</h2>
<p>In this post I showed how you can deploy security rules to your Network Security Group(s) in Azure using Bicep and how to get an deployment parameter template for your existing Network Security Groups.</p>
<p>Hopefully you found this useful. Have a nice day!</p></div><div class="post-footer" id="post-footer">
    <div class="post-info"><div class="post-info-tag"><span><a href="/tags/blog/">Blog</a>
                </span><span><a href="/tags/azure/">Azure</a>
                </span><span><a href="/tags/bicep/">Bicep</a>
                </span><span><a href="/tags/network-security-group/">Network Security Group</a>
                </span><span><a href="/tags/nsg/">NSG</a>
                </span><span><a href="/tags/jq/">jq</a>
                </span><span><a href="/tags/arm/">ARM</a>
                </span></div><div class="post-info-line"><div class="post-info-mod">
                <span>Updated on 27-05-2022</span>
            </div><div class="post-info-mod"></div>
        </div><div class="post-info-share">
            <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://jeroentrimbach.com/2022/05/azure-update-nsg-rules-bicep/" data-title="Update Azure NSG security rules using Bicep" data-hashtags="Blog,Azure,Bicep,Network Security Group,NSG,jq,ARM"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://jeroentrimbach.com/2022/05/azure-update-nsg-rules-bicep/" data-hashtag="Blog"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://jeroentrimbach.com/2022/05/azure-update-nsg-rules-bicep/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="https://jeroentrimbach.com/2022/05/azure-update-nsg-rules-bicep/" data-title="Update Azure NSG security rules using Bicep" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://jeroentrimbach.com/2022/05/azure-update-nsg-rules-bicep/"><i class="fab fa-reddit fa-fw"></i></a></span>
        </div></div><div class="post-nav"><a href="/2022/05/azure-boards-bulk-planning/" class="prev" rel="prev" title="Azure Boards: Planning work items in BULK!"><i class="fas fa-angle-left fa-fw"></i>Previous Post</a></div></div>
</div><div id="comments" class="single-card"><div id="vssue"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/meteorlxy/vssue">Vssue</a>.
            </noscript></div></article></div>
            </main>
            <footer class="footer"><div class="footer-container"><div class="footer-line">Hosted on GitHub</div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/"></a></span></div>
</div>
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker
        .register('/sw.min.js?version=1.0.1', { scope: '/' })
        .then(() => {
            console.info('Jeroen Trimbach\u00A0Service Worker Registered');
        }, err => console.error('Jeroen Trimbach\u00A0Service Worker registration failed: ', err));

    navigator.serviceWorker
        .ready
        .then(() => {
            console.info('Jeroen Trimbach\u00A0Service Worker Ready');
        });
}
</script>
</footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-chevron-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment-alt fa-fw"></i>
            </a></div><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><link rel="stylesheet" href="/lib/vue/vssue/vssue.min.css"><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><script src="/lib/vue/vue.runtime.min.js"></script><script src="/lib/vue/vssue/vssue.github.min.js"></script><script src="/lib/autocomplete/autocomplete.min.js"></script><script src="/lib/lunr/lunr.min.js"></script><script src="/lib/lazysizes/lazysizes.min.js"></script><script src="/lib/typeit/typeit.min.js"></script><script src="/lib/lightgallery/lightgallery.min.js"></script><script src="/lib/lightgallery/lg-thumbnail.min.js"></script><script src="/lib/lightgallery/lg-zoom.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script src="/lib/sharer/sharer.min.js"></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{"vssue":{"clientID":"af13e32b9a2ab81c4025","clientSecret":"237ea8b4e8aadc30b75ea5e941da285b7b908100","owner":"jeroen-t","repo":"comments","title":"Update Azure NSG security rules using Bicep"}},"data":{"id-1":"cd ~","id-2":"cd ~"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"},"typeit":{"cursorChar":"|","cursorSpeed":500,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":0,"speed":100}};</script><script src="/js/theme.min.js"></script><script data-goatcounter="https://jeroentrimbach.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></body></html>
